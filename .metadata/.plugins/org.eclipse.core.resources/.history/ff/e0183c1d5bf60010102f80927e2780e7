#include "MAX30003.h"
#include <stdint.h>

void MAX30003_WriteRegister(SPI_HandleTypeDef *hspi, uint8_t reg, uint32_t data)
{
    uint8_t tx_buf[4];

    tx_buf[0] = (reg << 1) | 0;      // Write command (R/W bit = 0)
    tx_buf[1] = (data >> 16) & 0xFF; // Data bits [23:16]
    tx_buf[2] = (data >> 8) & 0xFF;  // Data bits [15:8]
    tx_buf[3] = data & 0xFF;         // Data bits [7:0]

    MAX30003_CS_Low();
    HAL_Delay(1);
    HAL_SPI_Transmit(hspi, tx_buf, 4, 1000);
    HAL_Delay(1);
    MAX30003_CS_High();
}

uint32_t MAX30003_ReadRegister(SPI_HandleTypeDef *hspi, uint8_t reg)
{
    uint8_t tx_buf[4];
    uint8_t rx_buf[4] = {0, 0, 0, 0};

    tx_buf[0] = (reg << 1) | 1;  // Read command (R/W bit = 1)
    tx_buf[1] = 0x00;
    tx_buf[2] = 0x00;
    tx_buf[3] = 0x00;

    MAX30003_CS_Low();
    HAL_Delay(1);
    HAL_SPI_TransmitReceive(hspi, tx_buf, rx_buf, 4, 1000);
    HAL_Delay(1);
    MAX30003_CS_High();

    return ((uint32_t)rx_buf[1] << 16) |
           ((uint32_t)rx_buf[2] << 8) |
           ((uint32_t)rx_buf[3]);
}

void MAX30003_Init(SPI_HandleTypeDef *hspi)
{
    // Wait for chip to power up
    HAL_Delay(200);

    // 1. Software Reset
    MAX30003_WriteRegister(hspi, 0x08, 0x000000);
    HAL_Delay(100);

    // 2. CNFG_GEN: Enable ECG, Set Master Clock
    MAX30003_WriteRegister(hspi, 0x10, 0x810007);
    HAL_Delay(10);

    // 3. CNFG_ECG: Set Gain (20V/V) and Sample Rate (128sps)
    MAX30003_WriteRegister(hspi, 0x15, 0x805000);
    HAL_Delay(10);

    // 4. CNFG_RTOR: R-to-R detector (Optional)
    MAX30003_WriteRegister(hspi, 0x1D, 0x3fc600);
    HAL_Delay(10);

    // 5. SYNCH: Commit settings and start sampling
    MAX30003_WriteRegister(hspi, 0x09, 0x000000);
    HAL_Delay(100);
}

int MAX30003_ReadECG(SPI_HandleTypeDef *hspi)
{
    uint8_t tx_buf[4];
    uint8_t rx_buf[4] = {0, 0, 0, 0};
    int ecg_sample;

    // Read ECG FIFO BURST (register 0x08)
    tx_buf[0] = (0x08 << 1) | 1;   // = 0x11
    tx_buf[1] = 0x00;
    tx_buf[2] = 0x00;
    tx_buf[3] = 0x00;

    MAX30003_CS_Low();
    HAL_Delay(1);
    HAL_SPI_TransmitReceive(hspi, tx_buf, rx_buf, 4, 1000);
    HAL_Delay(1);
    MAX30003_CS_High();

    // Build ECG sample from bytes 1-3
    ecg_sample = ((int32_t)rx_buf[1] << 16) |
                 ((int32_t)rx_buf[2] << 8)  |
                 ((int32_t)rx_buf[3]);

    // Remove status bits (shift right by 6)
    ecg_sample >>= 6;

    // Sign extend from 18-bit to 32-bit
    if (ecg_sample & (1 << 17))
    {
        ecg_sample |= 0xFFFC0000;
    }

    return ecg_sample;
}

