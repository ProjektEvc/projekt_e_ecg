/*
 * PanTompkins.h
 *
 *  Created on: Jan 18, 2026
 *      Author: Gluscic
 */

#ifndef INC_PANTOMPKINS_H_
#define INC_PANTOMPKINS_H_

#include <stdint.h>
#include <stdlib.h>

/* ============================================================================
   CONFIGURATION - Adjust these for your application
   ============================================================================ */

#define PT_SAMPLE_RATE          128     // Hz
#define PT_FILTER_DELAY         11      // Samples (group delay from filters)
#define PT_PEAK_WINDOW          20      // Samples to look back for filtered peak
#define PT_INTEGRATION_WINDOW   20      // Moving window size (was 32 for 200Hz)
#define PT_RR_BUFFER_SIZE       8       // Number of RR intervals to average
#define PT_FILTERED_BUFFER_SIZE 64      // Must be power of 2

// Initial threshold values (will adapt automatically)
#define PT_INIT_THRESHOLD_F1    150     // Filtered signal threshold
#define PT_INIT_THRESHOLD_I1    4000    // Integrated signal threshold

// BPM limits
#define PT_MIN_BPM              30
#define PT_MAX_BPM              250

/* ============================================================================
   DATA STRUCTURES
   ============================================================================ */

typedef struct {
    // Filter states - Low Pass Filter
    int32_t lpf_y1;
    int32_t lpf_y2;
    int32_t lpf_x[26];
    int32_t lpf_n;

    // Filter states - High Pass Filter
    int32_t hpf_y1;
    int32_t hpf_x[66];
    int32_t hpf_n;

    // Filter states - Derivative
    int32_t der_x[4];

    // Filter states - Moving Window Integral
    int32_t mwi_x[32];
    int32_t mwi_idx;
    int64_t mwi_sum;

    // Signal buffers
    int32_t filtered[PT_FILTERED_BUFFER_SIZE];
    int32_t filtered_idx;
    int32_t integrated[3];

    // Peak detection - Filtered signal
    int32_t peak_f;
    int32_t spk_f;      // Signal peak
    int32_t npk_f;      // Noise peak
    int32_t threshold_f1;
    int32_t threshold_f2;

    // Peak detection - Integrated signal
    int32_t peak_i;
    int32_t spk_i;      // Signal peak
    int32_t npk_i;      // Noise peak
    int32_t threshold_i1;
    int32_t threshold_i2;

    // RR interval tracking
    int32_t rr_buffer[PT_RR_BUFFER_SIZE];
    int32_t rr_limited_buffer[PT_RR_BUFFER_SIZE];
    int32_t rr_idx;
    int32_t rr_limited_idx;
    int32_t rr_average1;
    int32_t rr_average2;
    int32_t rr_low_limit;
    int32_t rr_high_limit;
    int32_t rr_miss_limit;

    // Sample counting
    int32_t sample_count;
    int32_t last_qrs_sample;
    int32_t last_r_sample;

    // Output
    int32_t bpm;
    uint8_t beat_detected;
    uint8_t valid_bpm;

} PanTompkins_t;

/* ============================================================================
   GLOBAL INSTANCE
   ============================================================================ */

static PanTompkins_t pt;

/* ============================================================================
   FORWARD DECLARATIONS
   ============================================================================ */

static int32_t LowPassFilter(int32_t sample);
static int32_t HighPassFilter(int32_t sample);
static int32_t Derivative(int32_t sample);
static int32_t SquareSignal(int32_t sample);
static int32_t MovingWindowIntegral(int32_t sample);
static int32_t DetectPeak(int32_t prev_prev, int32_t prev, int32_t current);
static void UpdateSignalPeak(int32_t peak_value, int32_t *spk);
static void UpdateNoisePeak(int32_t peak_value, int32_t *npk);
static void UpdateSearchbackPeak(int32_t peak_value, int32_t *spk);
static int32_t CalculateThreshold1(int32_t npk, int32_t spk);
static int32_t CalculateThreshold2(int32_t threshold1);
static void UpdateRRAverage(int32_t rr_interval);
static int32_t CalculateBPM(int32_t rr_average);
static int32_t FindFilteredPeak(void);
#endif /* INC_PANTOMPKINS_H_ */
