/*
 * PanTompkins.h
 *
 *  Created on: Jan 18, 2026
 *      Author: Gluscic
 */

#ifndef INC_PANTOMPKINS_H_
#define INC_PANTOMPKINS_H_

#include <stdint.h>

// Configuration
#define PT_SAMPLE_RATE 200  // Hz
#define PT_BUFFER_SIZE 64
#define PT_RR_BUFFER_SIZE 8
#define PT_FILTER_BUFFER_SIZE 33

// Pan-Tompkins state structure
typedef struct {
    // Filter buffers
    int32_t lpf_y1;
    int32_t lpf_y2;
    int32_t lpf_x[26];
    int32_t lpf_n;

    int32_t hpf_y1;
    int32_t hpf_x[66];
    int32_t hpf_n;

    int32_t der_x[4];

    int32_t mwi_x[32];
    int32_t mwi_i;
    int64_t mwi_sum;

    // Signal processing buffers
    int32_t filtered[PT_BUFFER_SIZE];
    int32_t filtered_idx;
    int32_t integrated[3];

    // Peak detection variables
    int32_t peakf;
    int32_t speakf;
    int32_t npeakf;
    int32_t thresholdf1;
    int32_t thresholdf2;

    int32_t peaki;
    int32_t speaki;
    int32_t npeaki;
    int32_t thresholdi1;
    int32_t thresholdi2;

    // RR interval variables
    int32_t rr_buffer[PT_RR_BUFFER_SIZE];
    int32_t rr_lim_buffer[PT_RR_BUFFER_SIZE];
    int32_t rr_idx;
    int32_t rr_lim_idx;
    int32_t rr_avg;
    int32_t rr_avg_limited;
    int32_t rr_low_limit;
    int32_t rr_high_limit;
    int32_t rr_missed_limit;

    // Sample tracking
    int32_t n_samples;
    int32_t r_n_samples;
    int32_t last_r_n_samples;

    // Output
    int32_t bpm;
    int32_t heart_rate_valid;

} PanTompkinsState_t;


int PanTompkins(int data);
int LowPassFilter(int data);
int HighPassFilter(int data);
int Derivative(int data);
int MovingWindowIntegral(int data);
int PeakDetection(int prev_prev_data, int prev_data, int data);
int SignalPeak(int p, int sp);
int SignalPeak2(int p, int sp);
int Threshold1(int np, int sp);
int Threshold2(int t1);
int RRAverage1(int rr);
int RRAverage2(int rr, int rr_avg2);


#endif /* INC_PANTOMPKINS_H_ */
