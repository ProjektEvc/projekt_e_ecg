#include "MAX30003.h"
#include <stdint.h>

int MAX30003_ReadECG(SPI_HandleTypeDef *hspi)
{
    uint8_t tx_buf[4];
    uint8_t rx_buf[4] = {0, 0, 0, 0};
    int ecg_sample;

    /* Read ECG FIFO command */
    tx_buf[0] = (0x08 << 1) | 0x01;   // ECG_FIFO read
    tx_buf[1] = 0x00;
    tx_buf[2] = 0x00;
    tx_buf[3] = 0x00;

    uint8_t tx[] = {0xFF, 0xFF, 0xFF, 0xFF};
    uint8_t rx[4] = {0};
    MAX30003_CS_Low();
    HAL_SPI_TransmitReceive(hspi, tx, rx, 4, 1000);
    MAX30003_CS_High();

    MAX30003_CS_Low();

    /* We only send the FIFO read command, rest are dummy bytes */
    HAL_SPI_TransmitReceive(hspi, tx_buf, rx_buf, 4, 1000);

    MAX30003_CS_High();

    /*
     * rx_buf[1..3] contain ECG data
     * ECG FIFO data format:
     * [23:6] = ECG sample (18-bit signed)
     * [5:0]  = status bits
     */
    ecg_sample = ((int32_t)rx_buf[1] << 16) |
                 ((int32_t)rx_buf[2] << 8)  |
                 ((int32_t)rx_buf[3]);

    /* Remove status bits */
    ecg_sample >>= 6;

    /* Sign extend 18-bit value */
    if (ecg_sample & (1 << 17))
    {
        ecg_sample |= 0xFFFC0000;
    }

    return ecg_sample;
}

void MAX30003_CS_Low(void)
{
     HAL_GPIO_WritePin(MAX30003_CS_PORT, MAX30003_CS_PIN, GPIO_PIN_RESET);
}

void MAX30003_CS_High(void)
{
     HAL_GPIO_WritePin(MAX30003_CS_PORT, MAX30003_CS_PIN, GPIO_PIN_SET);


}


void MAX30003_WriteRegister(SPI_HandleTypeDef *hspi, uint8_t reg, uint32_t data) {
    uint8_t tx_buf[4];
    tx_buf[0] = (reg << 1) | 0;      // Register address shifted, R/W bit = 0 (Write)
    tx_buf[1] = (data >> 16) & 0xFF; // Data Bits [23:16]
    tx_buf[2] = (data >> 8) & 0xFF;  // Data Bits [15:8]
    tx_buf[3] = data & 0xFF;         // Data Bits [7:0]

    MAX30003_CS_Low();
    HAL_SPI_Transmit(hspi, tx_buf, 4, 1000);
    MAX30003_CS_High();
}

/* Initialization sequence to bring chip out of shutdown */
void MAX30003_Init(SPI_HandleTypeDef *hspi) {
    // 1. Software Reset
    MAX30003_WriteRegister(hspi, 0x08, 0x000000);

    // 2. CNFG_GEN: Enable ECG, Set Master Clock (Assuming 32kHz Internal Osc)
    // Bits: EN_ECG=1, RBias=1 (50M), Pol=0
    MAX30003_WriteRegister(hspi, 0x10, 0x810007);

    // 3. CNFG_ECG: Set Gain (20V/V) and Sample Rate (128sps)
    MAX30003_WriteRegister(hspi, 0x15, 0x805000);

    // 4. CNFG_RTOR: If you want to use the internal R-to-R detector (Optional)
    MAX30003_WriteRegister(hspi, 0x1D, 0x3fc600);

    // 5. SYNCH: This "commits" the settings and starts the sampling
    MAX30003_WriteRegister(hspi, 0x09, 0x000000);
}

