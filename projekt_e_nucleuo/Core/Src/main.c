/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "MAX30003.h"
#include "PanTompkins.h"
#include <string.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */

//parametri sinusa


/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
SPI_HandleTypeDef hspi2;
DMA_HandleTypeDef hdma_spi2_rx;
DMA_HandleTypeDef hdma_spi2_tx;

TIM_HandleTypeDef htim2;

UART_HandleTypeDef huart4;
DMA_HandleTypeDef hdma_uart4_rx;
DMA_HandleTypeDef hdma_uart4_tx;

/* USER CODE BEGIN PV */

uint8_t rx_byte;
char rx_buffer[32];
uint8_t rx_index = 0;


volatile uint8_t streaming = 0; //varijabla sa kojom ćemo pokrenut omogucit tj. onemogucit dma prijenos prema uartu
volatile int data = 0;
volatile uint16_t mock_index = 0;
volatile int bpm_main = 0;
volatile int ecg_data;



typedef struct __attribute__((packed)) {
    uint8_t  header;    // 0xAA
    int ecg_raw;   // 4 bytes (MAX30003 gives 24-bit, we store in 32
    int bpm;
    uint8_t  footer;    // 0xZZ
} ECG_Packet_t;
//__attribute__ govori kompajleru "sada  cu ti dat neku iznimnu nardebu", packed znači da se adrese u strukturi koju pošaljemo u
//mikrokontroler neće poravnati na adrese djeljive sa 4, već čemo ih "stisnut skupa


ECG_Packet_t myPacket;


volatile uint8_t transfer_complete = 1; // Zastavica kojom kontroliramo SPI prijenos


const int32_t ecg_mock_data[] = {
		6033, 5855, 5379, 5235, 5517, 5767, 5599, 5389, 4716, 4231, 4601, 5094, 6193, 6945, 7158, 6853, 6581, 6246, 5967, 5406, 5117, 5192, 5570, 5675, 5209, 4808, 4858, 5317, 6128, 6282, 6010, 5002, 4106, 3833, 4234, 4490, 4726, 4887, 5212, 5396, 5649, 5517, 5885, 8432, 11721, 13910, 15216, 14714, 12551, 10178, 8074, 6774, 5563, 5166, 5340, 4999, 4743, 4582, 4775, 3984, 3860, 4510, 5038, 5094, 5015, 4726, 4549, 4825, 5793, 6653, 6623, 6748, 6476, 4933, 2944, 2839, 3292, 3863, 4378, 5058, 4644, 4188, 4155, 4549, 4585, 4805, 5540, 5868, 5524, 5626, 5632, 5540, 5849, 6252, 6725, 7529, 7854, 7066, 6010, 4739, 4086, 4086, 4185, 3935, 3935, 4480, 4076, 3440, 3781, 5212, 6252, 6912, 7372, 7372, 6315, 5265, 5248, 4949, 4897, 5265, 5796, 4483, 2773, 1766, 1756, 2307, 2731, 3623, 4805, 5809, 5107, 3548, 4007, 5301, 6518, 6164, 5064, 3873, 3499, 3541, 4037, 4503, 4034, 2865, 2179, 2310, 2780, 3646, 4526, 5104, 4723, 4447, 4122, 4168, 6564, 8740, 7979, 4798, 1273, -617, -519, 282, 1959, 3745, 3725, 2691, 1733, 2199, 3193, 3410, 2754, 2261, 3177, 4595, 5225, 4946, 3807, 3338, 4211, 7145, 10217, 11159, 9932, 7835, 5307, 4172, 4707, 5964, 5964, 4247, 2770, 2901, 3407, 4109, 4349, 3482, 2140, 2143, 3384, 4490, 4368, 2898, 2192, 1907, 1877, 1936, 2064, 2347, 2662, 2859, 2944, 2694, 2770, 3049, 3223, 2767, 2563, 2796, 3571, 3728, 3929, 3978, 3820, 3239, 3200, 3525, 4080, 4139, 4227, 4043, 3594, 2596, 2064, 2265, 3138, 3636, 3715, 3686, 3341, 3029, 3082, 2901, 3056, 2944, 2484, 1979, 2146, 2593, 2665, 2491, 2438, 2379, 2205, 2461, 2478, 2442, 2780, 2783, 2662, 2143, 2117, 2767, 3643, 4109, 4290, 4165, 3479, 3157, 3331, 3804, 4447, 4424, 3630, 2704, 1966, 2665, 4040, 5343, 5534, 5205, 3696, 1779, 2504, 4300, 5402, 7401, 7848, 6417, 4647, 4080, 4217, 4703, 3945, -804, -6647, -4244, 1493, 5704, 7244, 8301, 8626, 7231, 6147, 6046, 5038, 3804, 3318, 3010, 4004, 5120, 5294, 4322, 5159, 8461, 11051, 11544, 8468, 1342, -2892, 1342, 7263, 9344, 8534, 6975, 5658, 4746, 4178, 4214, 4447, 4257, 3666, 3088, 3380, 4109, 3991, 3561, 3203, 3371, 3620, 3942, 3797, 3466, 2635, 2097, 3338, 4815, 5054, 4969, 4759, 4080, 2649, -1523, -2058, 2327, 6630, 7224, 7076, 6436, 5412, 4841, 4851, 5317, 5481, 5409, 5150, 4920, 5068, 3312, 2803, 4224, 5100, 4844, 5442, 5248, 4388, 3886, 4037, 4473, 4365, 3896, 4011, 4569, 5261, 4877, 3121, 2163, 2665, 3239, 3837, 4070, 3860, 3380, 3079, 2452, 830, -1563, 531, 5704, 9272, 10296, 8855, 5606, 3161, 2517, 3853, 4306, 3177, 2419, 2281, 2389, 2780, 3305, 3226, 3124, 3387, 4647, 4966, 4821, 3870, 2393, 2199, 2563, 3853, 4467, 4861, 4421, 3719, 2294, 2970, 4651, 6229, 5379, 3006, 709, -17, -365, 584, 1204, 1424, 1431, 1490, 1585, 2347, 2937, 3558, 3847, 4526, 6761, 8064, 8964, 9210, 7844, 6239, 5527, 5232, 4191, 3860, 4043, 3902, 3269, 2865, 2878, 2826, 2340, 2146, 2281, 2609, 2573, 2189, 1664, 1559, 1601, 2481, 3259, 3384, 2626, 2340, 2166, 2452, 2353, 2593, 2717, 2763, 2681, 2777, 2786, 3085, 3141, 2905, 2642, 2816, 3046, 3472, 3659, 3075, 2905, 3463, 3787, 4172, 4431, 4303, 4300, 4037, 3998, 4027, 3893, 3344, 2550, 1926, 1319, 2261, 3925, 5251, 5192, 4621, 3873, 2918, 2370, 2773, 3289, 3561, 3699, 3413, 3417, 3492, 3354, 2757, 2504, 2455, 2658, 3085, 3111, 2547, 1789, 1388, 1142, 1674, 3180, 4533, 4451, 3840, 2527, 2186, 2740, 3472, 3870, 3889, 3663, 3249, 2944, 2688, 2310, 1930, 1913, 2691, 3518, 3584, 2803, 1559, -20, -1257, 722, 2822, 4158, 3709, 2941, 1805, 659, 1037, 2337, 2885, 2918, 2937, 2924, 2957, 2868, 2530, 2589, 3502, 5724, 8242, 9367, 9896, 8878, 5918, 4267, 3932, 4172, 3758, 3525, 3502, 3331, 3742, 4103, 5018, 5773, 6413, 5747, 3167, 502, -1018, -1471, 896, 2517, 1693, 804, 249, 403, 75, 791, 2813, 4762, 5028, 5461, 5432, 5265, 6000, 6554, 4290, 1388, -443, -187, -151, 636, 1739, 1667, 1359, 1798, 2734, 4431, 5977, 6092, 5179, 3794, 2809, 2829, 3252, 3318, 2967, 4496, 4300, 1828, 180, 1152, 2793, 4454, 4066, 2987, 1710, 827, 121, 617, 1086, 1437, 1795, 2077, 2370, 3052, 3784, 2809, 1073, 614, 1300, 1286, 1526, 1818, 2166, 2310, 1963, 1605, 1447, 1556, 1713, 1592, 1621, 2002, 2291, 2310, 748, 420, 1966, 3571, 3305, 3033, 2983, 2639, 2025, 2143, 2031, 2360, 3548, 4070, 3121, 2225, 1588, 883, 518, 499, 2081, 2612, 1874, 1290, 1785, 3899, 5859, 5478, 3115, 702, -99, -453, -253, 518, 2087, 4454, 7214, 8235, 8596, 7444, 4874, 3095, 2632, 2655, 2852, 2836, 2022, 1575, 1854, 2694, 3108, 3039, 3052, 2310, 1949, 1782, 1135, 751, 1477, 2363, 2639, 2005, 1158, 640, 774, 1158, 1158, 998, 896, 1172, 1319, 1352, 866, 778, 1362, 2008, 2639, 2826, 2803, 2806, 3019, 3403, 3394, 3220, 2872, 2868, 2816, 2973, 2996, 3246, 3446, 3223, 2642, 2481, 2852, 3364, 3538, 3620, 3699, 3489, 3216, 2803, 2845, 2324, 1572, 2265, 3279, 4227, 4401, 4204, 3607, 3029, 3085, 3151, 3331, 3200, 3266, 3115, 2770, 2192, 1700, 1736, 2465, 3397, 3453, 3318, 3436, 3508, 3384, 3423, 3692, 3643, 3174, 2859, 2836, 3243, 3210, 2255, 1421, 2274, 3650, 4188, 4388, 4277, 4139, 3535, 2895, 2855, 2672, 1963, 1621, 2494, 3121, 3344, 3725, 3075, 1313, 407, 1391, 3610, 5061, 5136, 4352, 3466, 2809, 2514, 3246, 5488, 8068, 8524, 8688, 8934, 7618, 5734, 4605, 4365, 4437, 4513, 4687, 4598, 3633, 3344, 3551, 3636, 3751, 4559, 4657, 3600, 1894, 279, -624, 607, 2478, 3358, 3955, 4027, 3338, 2077, 1533, 1972, 2507, 3200, 3965, 4444, 4920, 4723, 3531, 2196, 2192, 2859, 2973, 2688, 2274, 2091, 2104, 1972, 2064, 2622, 3400, 3259, 3390, 4234, 5087, 5488, 5077, 3384, 3804, 6134, 9925, 10762, 7861, 3167, 207, -867, -772, 95, 1444, 2649, 2740, 2314, 2895, 3725, 4355, 3052, 1388, 709, 1687, 2570, 2734, 3344, 4391, 3443, 870, 541, 1575, 2100, 2425, 2468, 2639, 2271, 2127, 2750, 3351, 3978, 4828, 5041, 4707, 4798, 535, -4028, -12283, -18982, -20521, -20130, -19812, -20442, -22356, -24217, -25422, -25950, -25835, -24860, -24237, -24447, -25809, -26518, -23672, -19658, -18424, -20426, -24378, -28533, -31638, -32767, -24322, -12279, -3867, 837, 2750, 3719, 5891, 9390, 12249, 13047, 11734, 8265, 7060, 7470, 8717, 9820, 11061, 11708, 10841, 7057, 4428, 4040, 4014, 4729, 5770, 6098, 5156, 3876, 3856, 5396, 6781, 7372, 7473, 8425, 9252, 8146, 5672, 4667, 4733, 5261, 6098, 6712, 6833, 6591, 6508, 6860, 7224, 7191, 7021, 7122, 7217, 7556, 7556, 7615, 7523, 7592, 7716, 6978, 5760, 6036, 7076, 8238, 8957, 8905, 8895, 8366, 7716, 7408, 7490, 7638, 7336, 7503, 7759, 8015, 7812, 7191, 7355, 7710, 7723, 7585, 7044, 6633, 5800, 5015, 5219, 6505, 7953, 8754, 8366, 7375, 6722, 7021, 7247, 7047, 7336, 7700, 7792, 7254, 6134, 6410, 6679, 6528, 6433, 5941, 5087, 4434, 3669, 5159, 7375, 7733, 8173, 8560, 8583, 8173, 8130, 7605, 6676, 6312, 6177, 6423, 6515, 5721, 4500, 4510, 4759, 5163, 4500, 4208, 5127, 6738, 7290, 7789, 8222, 7785, 7037, 6581, 7536, 9755, 12167, 12154, 12735, 13736, 12390, 9469, 7766, 7480, 6673, 6351, 7011, 7224, 7375, 7647, 8681, 9837, 8363, 6791, 5573, 4487, 4096, 4093, 5763, 6338, 5100, 4155, 4060, 4493, 4982, 5399, 5524, 5658, 6817, 7618, 8438, 8849, 6971, 5136, 5629, 7254, 6958, 5018, 4237, 2898, 2005, 4047, 6358, 7024, 6134, 5327, 5438, 6810, 8458, 9062, 8176, 6174, 4011, 3469, 4172, 4749, 5409, 6486, 7693, 9157, 7165, 4411, 2980, 2849, 3016, 4119, 5363, 6584, 5652, 4244, 3197, 3636, 4070, 4316, 4762, 4946, 4654, 4546, 4185, 4362, 4496, 4605, 4365, 4421, 4178, 4280, 4198, 4362, 4418, 4552, 4835, 4769, 4588, 4473, 4752, 4782, 4923, 4795, 5084, 4759, 4785, 5097, 5340, 5077, 4812, 4254, 4329, 4894, 4992, 4414, 3948, 3810, 3525, 3216, 3036, 3328, 3371, 3505, 3430, 3630, 3893, 4316, 4657, 4798, 4447, 4720, 6029, 8179, 9659, 10621, 10119, 8094, 6751, 5875, 5796, 5606, 5622, 5744, 5491, 5025, 4647, 4457, 4185, 3745, 3653, 3807, 3994, 3975, 3787, 3686, 3794, 4145, 4145, 4011, 3922, 3991, 4112, 4132, 4030, 3948, 3988, 4089, 4119, 4231, 4339, 3988, 3732, 3761, 4208, 5028, 5452, 5655, 5773, 5468, 5104, 5084, 5219, 5133, 5268, 5117, 4707, 4267, 3804, 3912, 3528, 3312, 3837, 4877, 5370, 5855, 5708, 5852, 5330, 4861, 5100, 5248, 5557, 5681, 5284, 4231, 3226, 3433, 4365, 4894, 5127, 5038, 4513, 4260, 3768, 3371, 3820, 4227, 4572, 4920, 4385, 2219, 1329, 2255, 4231, 5580, 6564, 6515, 5452, 4690, 4300, 4313, 4992, 5544, 5268, 4956, 4569, 4424, 4746, 5215, 4523, 3650, 2977, 3417, 4129, 4930, 5845, 5698, 4946, 4352, 4221, 4556, 4956, 4903, 4628, 4309, 4168, 3184, 2058, 1624, 3446, 4821, 5087, 5622, 7785, 9801, 10903, 11681, 10848, 7401, 4644, 5360, 7473, 8665, 7667, 5619, 3656, 3469, 4277, 4779, 2859, 853, 216, 1405, 374, 2136, 5028, 6259, 5317, 5330, 5271, 4723, 3794, 4329, 5714, 6984, 6833, 5563, 4007, 1615, 1395, 2960, 4414, 3400, 2353, 2809, 3571, 3134, 3338, 4063, 4155, 3676, 3653, 4454, 5425, 5626, 5360, 4628, 4336, 4572, 5307, 6062, 6742, 7601, 7835, 6187, 4418, 2547, 1411, 1595, 2947, 3403, 3134, 2356, 2672, 3650, 3870, 2603, 2159, 2914, 4247, 4280, 4388, 4240, 3607, 3151, 3318, 4093, 4126, 4181, 4001, 3771, 3164, 3177, 3558, 4290, 4096, 3797, 3850, 3781, 3692, 3696, 3781, 3269, 1739, 2232, 4339, 5415, 5104, 4664, 4421, 4231, 4017, 4431, 4579, 4234, 3374, 3328, 3213, 3308, 3417, 3210, 3167, 3016, 3272, 3203, 3049, 3016, 3010, 3413, 3558, 3840, 4204, 4175, 4382, 5297, 7441, 9469, 10851, 11425, 10388, 8189, 6479, 5461, 5002, 4897, 5123, 4867, 4300, 3863, 3915, 3728, 3121, 2970, 2865, 3065, 3108, 3134, 2803, 2878, 3046, 3088, 2960, 2842, 2320, 2287, 3059, 3840, 4126, 4093, 4309, 4293, 3893, 3778, 3883, 4057, 4073, 3922, 4001, 4060, 4405, 4257, 4158, 4231, 4240, 3994, 3512, 3436, 3640, 4155, 5048, 5583, 5228, 4569, 3909, 3906, 3945, 4352, 3948, 3564, 4132, 4848, 5219, 5110, 4638, 4057, 3558, 3459, 3105, 3220, 3246, 3344, 3636, 3669, 3984, 4034, 3774, 3124, 2573, 2632, 2993, 3669, 4024, 4126, 3866, 3295, 2793, 2875, 3449, 3935, 4027, 4017, 3361, 2576, 2616, 3742, 3863, 3531, 2891, 1792, 1677, 2996, 4444, 5412, 5133, 4441, 3817, 3364, 3023, 3095, 2836, 2665, 2422, 2235, 2842, 3531, 3791, 3446, 2547, 2356, 3689, 4595, 4884, 5297, 6486, 8117, 9751, 11416, 13034, 12587, 8678, 5452, 4103, 4582, 4309, 3945, 3528, 3223, 3220, 2688, 3289, 4795, 5642, 5173, 4963, 5511, 5744, 5635, 4470, 3886, 3771, 2987, 837, 689, 2199, 3617, 4516, 4408, 3640, 3184, 2911, 3282, 3709, 4894, 5822, 6387, 6643, 5783, 4493, 3646, 3101, 3784, 4034, 3252, 2964, 2622, 3174, 3899, 4300, 4510, 4467, 4434, 4322, 4470, 4854, 4841, 4664, 4372, 4286, 4624, 4421, 4290, 4021, 4089, 4198, 4014, 3548, 2918, 2757, 3548, 4454, 4431, 3955, 3298, 3256, 3833, 4303, 4634, 5228, 4864, 3958, 2898, 2744, 3371, 4103, 4621, 4467, 3824, 3495, 3377, 3604, 3417, 3968, 4621, 4903, 3669, 3561, 3998, 3945, 4257, 5944, 6925, 6118, 4011, 2465, 1414, 1352, 1969, 2609, 3147, 3216, 3016, 3013, 3197, 3131, 3236, 3049, 3023, 3177, 3302, 3430, 3459, 3984, 4109, 4267, 5570, 7447, 9069, 9876, 9456, 7437, 5842, 5107, 5790, 5274, 5189, 5301, 4946, 4424, 4103, 4004, 3735, 3220, 3069, 3262, 3528, 2957, 2537, 2734, 2806, 3049, 2767, 2800, 2960, 2402, 2655, 3331, 3535, 3541, 3420, 3463, 3354, 3371, 3170, 3213, 3052, 3351, 3564, 3929, 3587, 3847, 3955, 3975, 3761, 3981, 4004, 3945, 3446, 2868, 3023, 4089, 4572, 4398, 3781, 3732, 4270, 4283, 4546, 5140, 5278, 5068, 4743, 4227, 4198, 4277, 3666, 3013, 2721, 2826, 3410, 3190, 2822, 2793, 2865, 3377, 4263, 4861, 5117, 4355, 2629, 1726, 3239, 4789, 5452, 5389, 4483, 3653, 3325, 3443, 3883, 3807, 3101, 3039, 4208, 5268, 5803, 5484, 4034, 2150, 2278, 4411, 5842, 6735, 6738, 5291, 3354, 2136, 3138, 4277, 4838, 4707, 4047, 3118, 2445, 2494, 3210, 3308, 2340, 1257, 705, 2734, 5852, 7231, 7119, 7089, 7861, 9876, 11823, 13707, 14117, 11504, 8632, 6121, 4526, 3748, 3472, 2632, 2914, 4181, 4920, 5169, 4707, 3679, 4076, 5399, 6505, 7306, 6295, 4158, 2593, 1746, 2271, 3449, 3535, 3193, 2340, 2228, 3010, 3925, 4040, 3778, 3377, 3302, 3495, 3938, 4864, 6233, 6945, 5320, 3810, 4096, 5918, 7565, 7441, 6085, 4464, 3856, 4021, 3676, 2993, 1815, 1697, 2081, 2678, 3151, 4470, 5265, 5678, 6394, 7342, 7168, 5307, 2960, 2100, 2084, 2931, 3558, 3554, 3164, 1972, 1263, 2415, 4181, 5251, 5366, 4710, 4250, 3810, 3883, 4769, 6019, 5008, 1644, 46, 870, 2058, 2878, 3380, 3508, 3124, 1762, 1247, 3932, 6312, 6735, 6308, 4713, 1267, 410, 3407, 8616, 9499, 6210, 1037, -870, 292, 2478, 5691, 6679, 4165, 955, 151, 843, 1595, 1818, 1582, 1418, 2219, 3075, 3141, 2642, 2704, 3577, 4336, 4825, 5757, 8278, 10217, 11261, 11008, 9193, 7254, 5363, 4247, 3453, 3161, 3581, 3118, 2310, 2347, 3118, 3262, 2901, 2783, 2232, 1802, 2284, 2619, 2701, 3013, 3013, 2914, 2855, 2717, 2438, 2452, 2156, 1894, 1749, 2028, 1841, 1966, 2097, 1943, 2038, 2622, 3472, 3604, 3722, 3673, 3663, 3515, 3614, 3879, 4021, 4053, 3758, 3476, 2750, 2865, 3417, 4421, 4552, 4526, 4326, 4096, 3886, 3768, 4267, 4254, 3725, 3400, 3617, 4365, 4897, 4670, 3915, 3384, 3056, 3456, 3581, 3292, 3243, 3295, 3243, 3541, 4030, 3820, 3361, 2757, 3174, 3932, 4473, 4122, 3646, 3482, 3377, 3459, 3298, 3994, 4217, 3591, 3548, 3725, 3000, 2688, 3407, 5159, 6239, 6443, 6515, 5186, 3827, 3430, 3988, 4523, 4286, 3709, 3554, 3614, 3479, 2901, 2409, 2626, 3344, 3919, 3433, 2727, 3161, 3902, 4162, 4897, 6006, 5914, 5583, 4513, 6072, 9620, 12889, 13769, 11622, 8806, 6407, 5209, 4204, 3719, 3899, 4529, 4201, 4034, 5228, 6459, 6210, 5166, 4661, 4670, 5327, 5304, 4618, 3636, 2452, 3157, 4142, 3308, 2931, 3525, 3686, 4060, 4273, 4693, 4326, 3955, 4119, 4063, 4066, 4116, 4713, 5232, 6518, 6922, 5931, 4359, 2951, 3249, 3229, 3384, 2937, 3013, 3853, 4880, 5012, 5091, 5271, 4940, 4556, 4989, 6495, 7247, 7841, 7211, 4437, 4559, 5248, 5265, 3446, 1329, 1779, 2393, 2498, 2747, 3252, 3538, 3069, 3010, 3147, 3732, 4421, 5012, 5196, 3824, 3088, 3699, 3955, 3929, 4739, 6847, 7825, 6755, 3541, 899, 1109, 1864, 2468, 3161, 3804, 3893, 3732, 3548, 3577, 3765, 3673, 3568, 3397, 3761, 4277, 5337, 5100, 2783, 1329, 1286, 1657, 2691, 3387, 3069, 2415, 2045, 1969, 2701, 3870, 4631, 5173, 6692, 7539, 7552, 6341, 6177, 7690, 8297, 6850, 6298, 5967, 5383, 4556, 3873, 4263, 4707, 4004, 3269, 3131, 3784, 3830, 3262, 2790, 2947, 3486, 3377, 3312, 3059, 3331, 3804, 3732, 3190, 2970, 2580, 2780, 3085, 3535, 3541, 3758, 3952, 3883, 3594, 3039, 2258, 2209, 2652, 3105, 3551, 3984, 4539, 4808, 4720, 4605, 4608, 4342, 4043, 3784, 3830, 4162, 4641, 4769, 4785, 4490, 4408, 4441, 4162, 4014, 3742, 3824, 4004, 3919, 3820, 3778, 3466, 3617, 3689, 4349, 4329, 4083, 4070, 3722, 3577, 3554, 3673, 3833, 4076, 4336, 4152, 3922, 3879, 3879, 3915, 3942, 3925, 4076, 4441, 4657, 4710, 4168, 3400, 3154, 3456, 4004, 4447, 4920, 5123, 5445, 5022, 4703, 4579, 4349, 4257, 4034, 3909, 3978, 3945, 3863, 3653, 3719, 3955, 3922, 3495, 2937, 1851, 1670, 3059, 4992, 5826, 5954, 5957, 6528, 7326, 8051, 9535, 9994, 8232, 6863, 6098, 6118, 5701, 5232, 4933, 4365, 4332, 3709, 3466, 3574, 2990, 2580, 2543, 2652, 2754, 2599, 2777, 2914, 3213, 3719, 4519, 5251, 5422, 4667, 3528, 1992, 1621, 1986, 2688, 3180, 3538, 3817, 3787, 3702, 3801, 3942, 4194, 4162, 4470, 4575, 4733, 4986, 4940, 5238, 5159, 5333, 5202, 4769, 4483, 4014, 4349, 4559, 4884, 5022, 4434, 4060, 3856, 3886, 4152, 4359, 4434, 4293, 4132, 4155, 3945, 4040, 4106, 4126, 4510, 4303, 4441, 4345, 3968, 4126, 4263, 4391, 4352, 4017, 4152, 4234, 4536, 4720, 4618, 4572, 4634, 4903, 5081, 4818, 4989, 4835, 4894, 4884, 5012, 5350, 5573, 5652, 5498, 5635, 4989, 4634, 4687, 4300, 3873, 4208, 4191, 4057, 4112, 3896, 4021, 4172, 4405, 4290, 4316, 4999, 5665, 6269, 6229, 6147, 6252, 6646, 7733, 8626, 9571, 8845, 7066, 6216, 5740, 5714, 5383, 4693, 4306, 4756, 5399, 5455, 5649, 4969, 4106, 3738, 3673, 3594, 3354, 3338, 3174, 3082, 2800, 2770, 2573, 3354, 3597, 3909, 3948, 3814, 3443, 3827, 3666, 4083, 4188, 4247, 4063, 3886, 3696, 3988, 4037, 3486, 3528, 3873, 4119, 4211, 4480, 4503, 4647, 4716, 5005, 5435, 5445, 5612, 5527, 5251, 4526, 4313, 4595, 4657, 4624, 4172, 4162, 4007, 4234, 4017, 3984, 3975, 3998, 4021, 4017, 3991, 3978, 3807, 3646, 3827, 3778, 4145, 4172, 3853, 3312, 3633, 3902, 4089, 4024, 4500, 4615, 5061, 5054, 5199, 5110, 5045, 5084, 4851, 4979, 4149, 2622, 2287, 3042, 4519, 5649, 5698, 5566, 5186, 5186, 5219, 4864, 4418, 4460, 4582, 4746, 5363, 5731, 5274, 4139, 3705, 3975, 4982, 6256, 6203, 4992, 4769, 5803, 8169, 10542, 12377, 12797, 10995, 8632, 7142, 6292, 5550, 5169, 4858, 4378, 4487, 4303, 4339, 4093, 4217, 4644, 5366, 5996, 6049, 5498, 4969, 4447, 4224, 4437, 4467, 4726, 4798, 5173, 5028, 4720, 4401, 4418, 4723, 5153, 5271, 5199, 4667, 4391, 4204, 4277, 4365, 4421, 4372, 4414, 4490, 4556, 4595, 5307, 5353, 5475, 5386, 5399, 5678, 5905, 6039, 5980, 5622, 4949, 3843, 3568, 3784, 4300, 4995, 5340, 5169, 4306, 4221, 4395, 4273, 3971, 3577, 3479, 3781, 4188, 4487, 4175, 3765, 3853, 3971, 4217, 4516, 4733, 4467, 4224, 4060, 4306, 4487, 4441, 4618, 4838, 4687, 4516, 4293, 4431, 4789, 5202, 5635, 5468, 4900, 4309, 4083, 4227, 4405, 4447, 4500, 4493, 4254, 4231, 4060, 4096, 4089, 4050, 4030, 4244, 4270, 4280, 3886, 3689, 3673, 4037, 4030, 4631, 5022, 5219, 4667, 4513, 5796, 8507, 10562, 12124, 11849, 8727, 5721, 4418, 4342, 4618, 5488, 5793, 4309, 2639, 2435, 3033, 3226, 3426, 3443, 3453, 3636, 3617, 3627, 3650, 3843, 4011, 4188, 4024, 3502, 3699, 3991, 4687, 4736, 4126, 3256, 2383, 2189, 2494, 2993, 3535, 3738, 3807, 3728, 3801, 4109, 4490, 4388, 4155, 3479, -1126, -5006, -7746, -9923, -11593, -12834, -13881, -15135, -15893, -16451, -16211, -16267, -17373, -18752, -19904, -20219, -19454, -17515, -15388, -11839, -4874, -850, 1831, 3417, 4470, 4812, 4805, 5242, 5586, 5468, 5448, 5603, 6157, 6492, 6446, 6292, 6046, 6151, 6256, 6410, 6472, 6239, 6157, 6440, 6761, 7201, 7559, 7690, 7631, 7401, 7247, 6975, 6876, 7188, 6971, 6669, 6420, 6659, 6915, 7670, 8159, 8340, 7684, 6843, 5842, 5475, 5527, 5589, 5951, 6564, 6620, 6338, 6226, 5786, 5796, 6577, 7382, 7670, 7736, 8202, 9305, 10017, 9945, 8800, 7628, 8054, 8524, 8547, 8123, 8084, 6814, 4782, 5084, 7083, 9023, 9170, 7345, 5662, 5136, 5406, 5438, 5829, 6364, 6279, 6610, 6456, 6426, 5793, 4414, 3988, 4483, 5629, 7093, 7598, 7007, 6479, 6177, 6466, 7050, 7657, 7254, 6495, 5813, 5885, 6554, 6919, 7214, 6817, 5786, 5301, 5189, 5373, 5717, 6266, 6423, 6394, 6039, 6335, 6410, 7122, 7506, 7779, 7910, 7047, 6059, 5655, 5429, 5274, 4821, 4858, 5425, 5566, 5255, 5235, 4884, 4867, 4798, 5022, 5350, 5415, 5281, 5261, 5616, 6236, 6302, 5333, 4654, 4542, 4785, 4976, 5064, 6010, 7221, 7057, 6581, 5616, 4995, 4923, 4254, 4329, 5117, 6620, 7917, 7917, 6781, 5366, 5068, 4615, 3341, 2629, 4290, 5448, 5284, 3856, 3216, 3751, 3807, 2724, 2914, 3725, 5133, 6042, 5511, 5018, 5566, 5498, 4693, 4808, 6302, 9535, 12535, 12975, 10982, 7854, 6056, 5524, 4710, 3922, 4234, 4782, 4661, 3761, 3797, 5714, 6157, 5048, 3423, 2284, 2235, 2882, 3466, 3679, 3282, 2773, 2248, 2320, 2412, 2970, 2934, 2714, 3170, 3725, 4414, 4657, 4368, 4083, 4165, 4539, 4956, 4752, 4362, 4237, 3952, 4135, 4142, 4165, 4608, 4871, 5255, 5511, 5379, 5061, 5097, 5228, 5274, 5186, 5081, 5097, 4825, 4510, 4437, 4674, 5022, 5333, 5278, 4703, 4011, 3531, 3738, 4372, 4401, 4398, 4181, 4546, 4539, 4388, 4047, 3840, 3587, 3929, 4690, 5117, 5186, 5402, 5347, 5301, 5130, 4815, 4076, 3272, 2622, 2947, 4444, 5415, 5721, 5274, 4516, 4569, 5360, 6318, 6886, 6679, 6459, 5694, 4460, 3249, 2987, 3056, 3597, 3751, 4355, 4162, 3358, 2583, 3016, 3630, 4378, 5796, 6824, 6364, 5366, 4779, 4690, 4802, 4887, 5652, 7188, 9597, 10903, 12643, 14422, 13506, 10900, 8061, 7011, 5314, 4316, 5242, 5685, 6430, 6998, 6666, 5934, 5265, 4385, 3870, 4224, 4428, 3853, 3302, 2973, 3210, 3541, 3784, 3889, 4168, 4188, 3942, 3833, 3551, 3784, 4319, 4821, 5337, 5330, 5038, 4227, 4290, 5077, 5399, 4999, 4700, 4936, 3735, 2750, 2911, 3236, 3420, 4053, 4854, 5219, 5593, 5619, 5291, 5304, 4864, 4441, 4263, 4664, 4831, 4634, 4477, 4493, 4464, 4050, 3689, 3151, 2951, 3446, 4135, 3994, 3394, 3082, 3495, 4424, 5012, 5281, 4913, 3679, 2665, 1585, 1707, 2783, 4237, 4490, 3814, 3272, 3489, 4004, 4191, 3965, 2957, 2839, 2878, 4451, 5859, 5934, 4375, 2685, 1408, 2274, 4004, 4628, 3876, 4011, 3975, 3384, 2478, 692, 79, 269, 1208, 2760, 3650, 3289, 3059, 3115, 3111, 2809, 3502, 4034, 3863, 4447, 5484, 7300, 9006, 10611, 10306, 8438, 6522, 4821, 3988, 3827, 3866, 4418, 4428, 3105, 2189, 2317, 2563, 2603, 2340, 2760, 3023, 2370, 1592, 1319, 1549, 2639, 3190, 2793, 2097, 1703, 2031, 2481, 2537, 2343, 2360, 2422, 2639, 2721, 2767, 2970, 2996, 3016, 2944, 3006, 2990, 3170, 3364, 3515, 3433, 3243, 3010, 3161, 3476, 3600, 3453, 3433, 3364, 3282, 3417, 3643, 3787, 3735, 3883, 3840, 3676, 3610, 3719, 3850, 3833, 3705, 3446, 3528, 3443, 3440, 3331, 3449, 3692, 3610, 3650, 3377, 3289, 3298, 3574, 3994, 4322, 4083, 3751, 2885, 3075, 3495, 3587, 4076, 4428, 4454, 3961, 3679, 3331, 3614, 4372, 4844, 4825, 4936, 4654, 4618, 5228, 5340, 4720, 3971, 3187, 1624, 344, 591, 492, 522, 820, 1116, 2849, 3873, 5878, 6843, 7050, 6354, 5091, 3919, 4710, 6229, 6847, 6965, 8100, 10339, 11156, 11862, 11363, 9134, 7165, 6630, 7158, 6354, 6105, 6059, 6072, 5550, 5701, 6781, 7332, 6312, 4769, 3902, 3833, 3899, 3315, 3006, 3469, 3932, 3863, 3581, 3653, 4017, 4624, 4992, 4979, 4693, 4835, 4812, 4982, 5360, 5629, 5763, 5412, 4126, 3935, 3873, 3318, 3394, 4273, 4828, 5186, 5278, 4818, 3814, 3594, 4378, 5265, 5800, 6515, 6229, 5511, 4995, 5199, 4677, 3906, 3643, 4559, 5199, 6079, 5488, 4237, 4355, 4388, 3801, 3518, 4821, 5977, 5448, 4106, 3548, 3554, 3006, 2461, 2678, 2514, 2586, 2849, 3574, 5048, 5698, 4634, 2790, 2278, 3771, 5514, 6318, 5038, 3039, 2501, 3495, 4066, 3889, 3318, 3239, 3906, 4339, 3249, 2658, 2596, 2540, 3062, 3508, 3568, 3262, 2511, 1999, 2675, 3207, 3742, 4848, 5310, 4273, 2993, 1634, 692, 1720, 3558, 4411, 3584, 3899, 6679, 9472, 12013, 13437, 12568, 9751, 7424, 7579, 7815, 5691, 3115, 2419, 1841, 2609, 3640, 3216, 2189, 1483, 1477, 1940, 2120, 2189, 1943, 2097, 2301, 2481, 2222, 2209, 2314, 2455, 2642, 2822, 2639, 2547, 2845, 2996, 3200, 3065, 2793, 2868, 3170, 3170, 3082, 3213, 3252, 3161, 3190, 3108, 3216, 3614, 3893, 3958, 3742, 3669, 3824, 3860, 3932, 3945, 3886, 4024, 4043, 4116, 4145, 3909, 3856, 3850, 3896, 3742, 3541, 3305, 3088, 3295, 3502, 3321, 3515, 3682, 3860, 3883, 3922, 3738, 3522, 3492, 3673, 3876, 4096, 3919, 3732, 3712, 3495, 3689, 3889, 4277, 4277, 4296, 4496, 4667, 4654, 4303, 4149, 3938, 3505, 3486, 4060, 4257, 4293, 3948, 3380, 3335, 3830, 4001, 4089, 3804, 3791, 3856, 3787, 4057, 3607, 3446, 3508, 3384, 4185, 4874, 4956, 4746, 4661, 5928, 8750, 11081, 12026, 11294, 9069, 7375, 5767, 5104, 4467, 4795, 5468, 5842, 5271, 4936, 4684, 3955, 3154, 2750, 2731, 3026, 3489, 3699, 3909, 3725, 3853, 3358, 2983, 2951, 2898, 2836, 2970, 2990, 2941, 3269, 3587, 3554, 3617, 3748, 4027, 4336, 3961, 3502, 3426, 3236, 3312, 3725, 4234, 4365, 4047, 3781, 3220, 2353, 2442, 3174, 3998, 4667, 4523, 3377, 2777, 2511, 2268, 2672, 3095, 3305, 3492, 3856, 4418, 4631, 4122, 3039, 2816, 3420, 4263, 4185, 3856, 3161, 2576, 2347, 2360, 2018, 1605, 1661, 1949, 2465, 2901, 3715, 4208, 4152, 3722, 3187, 2990, 3049, 3893, 5317, 5947, 5169, 3335, 2068, 2445, 3912, 5008, 4795, 4217, 3292, 2291, 2629, 3082, 1999, 1080, 1050, 1759, 2675, 3430, 3633, 2757, 1572, 1621, 2186, 2501, 2875, 3702, 4513, 4710, 3965, 4181, 6197, 7972, 10126, 11868, 11301, 8327, 4624, 2672, 2205, 2701, 4201, 4956, 3870, 2294, 1972, 2219, 2422, 3144, 3417, 3558, 2330, 1231, 722, 850, 1280, 2189, 3069, 2481, 1424, 919, 1066, 1382, 2701, 4194, 4378, 2619, 761, 384, 794, 1217, 1867, 2458, 2931, 2816, 2685, 2704, 2655, 2543, 2271, 2324, 2301, 2422, 2527, 2672, 2356, 2337, 2803, 3059, 3049, 2803, 2786, 3000, 3029, 3042, 3023, 2813, 2822, 2836, 2649, 2645, 2626, 2622, 2639, 2465, 2468, 2632, 2796, 2816, 2865, 2882, 3036, 3184, 3387, 3446, 3295, 3085, 3026, 3184, 3403, 3463, 3298, 3079, 3213, 3568, 3604, 3682, 3696, 3824, 3955, 3981, 4070, 4099, 4037, 3597, 3433, 3108, 2740, 2494, 2609, 2790, 2675, 1999, 1611, 1680, 1766, 1825, 2724, 4063, 4342, 3975, 3735, 3794, 3866, 3732, 4329, 6151, 8832, 10680, 11704, 11150, 9594, 7789, 5803, 4690, 3984, 3935, 4490, 4890, 4821, 5159, 4936, 3607, 1959, 1818, 2307, 2941, 3459, 3712, 3459, 2251, 2087, 3413, 3909, 3761, 2957, 2455, 1940, 1759, 1368, 2478, 4428, 5091, 4910, 4306, 4024, 3902, 2767, 2777, 3833, 4624, 4408, 4231, 3502, 3512, 4004, 3745, 3627, 3915, 4460, 4542, 4529, 4634, 4523, 4483, 4372, 4145, 3856, 3564, 3522, 3761, 3893, 4382, 4887, 4887, 3856, 3072, 2704, 2504, 2842, 3554, 3952, 3863, 3755, 3141, 2662, 2983, 3193, 3659, 3702, 4244, 4359, 3810, 3541, 3748, 3630, 3738, 2852, 2813, 3358, 3554, 3302, 3275, 3991, 4477, 4313, 3948, 3742, 3256, 2951, 2954, 3298, 4017, 4539, 4332, 3098, 2307, 2314, 1549, 1178, 2465, 3318, 2616, 2448, 2301, 2301, 2501, 2566, 2051, 1979, 3098, 5822, 9600, 12633, 15157, 15410, 11419, 7743, 5429, 3948, 3003, 2757, 3036, 3128, 3682, 3955, 3929, 3285, 1523, 742, 1053, 1224, 1549, 2606, 3423, 3039, 1227, 233, 899, 929, 400, 101, 466, 853, 1083, 1565, 2603, 2763, 1913, 2041, 3154, 3817, 3272, 1884, 1309, 2038, 1907, 1401, 1329, 1191, 1112, 1122, 1145, 1464, 1782, 1946, 2320, 2662, 2599, 2251, 1713, 1063, 1457, 2435, 3269, 3279, 2770, 2370, 2271, 2268, 1923, 1641, 1782, 2196, 2399, 2150, 2120, 2393, 2721, 2370, 2035, 1644, 1644, 1880, 2094, 2396, 2271, 1910, 1926, 2268, 2540, 2839, 2717, 2931, 3243, 3308, 3256, 2973, 2967, 3036, 3279, 3243, 3187, 2996, 2675, 2524, 2284, 2212, 2199, 2448, 2685, 2672, 2448, 2255, 2278, 2097, 2087, 2251, 1864, 1910, 1542, 1900, 2589, 2957, 3433, 4467, 6318, 7923, 9121, 9531, 8557, 6617, 5826, 5228, 4690, 4145, 4231, 4411, 4194, 4080, 3765, 3673, 2905, 1933, 453, 282, 1414, 2488, 3134, 3374, 3686, 3105, 2258, 1313, 1992, 3298, 4263, 4556, 4539, 4260, 3784, 3361, 2842, 2773, 2836, 2937, 3138, 3610, 3915, 3991, 3380, 3049, 3088, 3853, 4621, 5035, 4841, 4588, 4542, 4428, 4398, 4043, 2534, 1582, 1926, 3400, 4716, 4766, 4086, 3167, 3331, 3653, 3833, 4782, 5287, 5110, 4529, 4697, 4963, 5228, 5087, 4378, 3801, 3459, 3463, 3275, 3154, 3561, 4188, 4401, 4273, 3991, 3807, 3824, 3817, 4047, 4700, 5468, 5547, 4887, 4579, 5114, 5363, 5091, 4562, 4286, 4533, 5255, 5553, 4575, 4053, 3489, 3486, 3689, 4260, 4940, 5228, 5094, 3804, 3039, 2862, 2829, 3220, 4063, 4684, 4992, 4684, 4135, 4506, 4624, 5104, 6184, 8494, 10726, 12272, 13516, 12252, 9850, 8153, 6705, 6147, 4677, 3748, 4572, 5511, 5540, 4880, 4684, 4286, 3213, 1887, 1779, 3000, 4257, 4060, 4093, 4231, 4792, 4086, 2425, 1887, 3016, 4359, 4867, 4017, 2504, 1697, 1703, 2196, 3384, 4441, 4966, 4956, 4903, 4060, 3696, 4930, 5993, 5409, 4362, 3479, 3256, 2862, 2629, 2527, 3932, 5429, 4969, 4168, 3141, 3220, 3594, 3699, 4296, 6709, 9203, 8386, 3935, 1086, 1677, 2173, 3761, 5199, 4782, 3321, 1953, 1923, 3039, 4473, 5491, 5885, 5573, 4943, 4953, 5287, 5429, 4208, 4234, 5314, 4979, 4083, 3561, 3870, 4234, 4306, 4457, 4923, 5396, 5580, 5514, 5672, 5708, 5960, 5960, 5914, 5694, 5717, 5560, 5557, 5327, 5304, 5123, 4966, 4966, 5110, 5074, 5107, 5156, 4972, 4746, 4516, 4516, 4726, 5297, 5468, 5865, 6272, 6101, 6495, 8714, 12019, 13772, 14845, 14530, 12203, 9679, 7565, 6778, 6088, 6118, 6207, 6108, 5960, 5891, 5921, 5622, 5153, 5186, 5074, 5097, 4838, 4211, 3860, 3902, 4624, 5114, 4759, 4329, 4949, 5737, 6358, 6653, 6141, 5855, 5829, 5944, 6354, 6065, 5691, 5156, 5025, 4936, 5744, 6722, 7414, 7391, 7172, 6610, 5635, 5530, 5793, 6430, 6840, 7145, 7332, 6666, 6128, 6827, 7208, 7428, 7841, 7897, 7795, 6863, 6354, 6515, 6637, 7257, 7345, 6581, 5507, 5396, 5619, 5612, 5901, 6656, 6932, 6597, 6623, 7451, 7575, 7516, 7231, 6659, 6305, 6787, 7234, 6942, 6653, 6361, 6440, 6440, 6489, 6390, 6531, 6837, 7211, 7227, 7887, 8232, 8215, 8071, 7487, 7300, 7030, 7214, 6699, 6134, 6115, 6371, 6364, 6121, 6154, 5895, 6325, 6335, 6318, 6170, 6272, 6285, 6134, 6151, 6919, 7332, 7572, 8281, 10766, 13697, 15272, 16326, 15912, 14038, 11704, 9230, 8662, 7500, 6840, 6545, 6390, 6751, 7185, 7752, 7900, 7592, 6627, 5914, 4907, 4227, 4030, 4339, 5343, 5767, 4858, 4198, 4611, 5422, 5809, 5996, 6197, 6587, 7526, 7135, 6833, 6118, 4559, 3719, 3801, 4316, 5882, 7099, 7559, 6853, 5727, 4713, 4034, 3784, 4185, 5360, 6118, 6331, 6019, 5117, 4703, 5143, 5990, 6440, 7007, 7080, 7726, 7191, 5373, 4073, 4043, 4841, 4815, 4122, 4329, 5041, 6305, 6830, 5872, 4336, 4116, 3824, 3394, 4516, 6443, 8025, 8320




};


/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_UART4_Init(void);
static void MX_SPI2_Init(void);
static void MX_TIM2_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

void stop_streaming(void);
void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart); //poziva se nakon prijenosa svakog paketa
void start_stream(void);
void send_packet(void);
int generate_ecg_sample(void);
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef* htim); //poziva sa frekvnecijom 128 Hz



/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_UART4_Init();
  MX_SPI2_Init();
  MX_TIM2_Init();
  /* USER CODE BEGIN 2 */

  HAL_TIM_Base_Start_IT(&htim2);
  HAL_UART_Receive_IT(&huart4, &rx_byte, 1); //omogucujemo interrupt da povežemo python sa mikrokontrolerom
  PanTompkins_Init();
  myPacket.header = 0xAA;
  myPacket.footer = 0x0A;
  myPacket.bpm = 0;
  MAX30003_Init(&hspi2);




  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
	  if (streaming)
	    {
	      if(transfer_complete == 0){
	    	  transfer_complete = 1;
	//   	  ecg_data = MAX30003_ReadECG(&hspi2);
	    	  ecg_data = generate_ecg_sample();
	   	myPacket.ecg_raw = ecg_data;
	    	  bpm_main = PanTompkins_Process(ecg_data);
	    	  myPacket.bpm = bpm_main;
	    	  HAL_UART_Transmit(&huart4, (uint8_t*)&myPacket, sizeof(myPacket), 5); //5 ms timeout


	      }
	    }
	    else
	    {
	      // Kad nema streaming, provjeri UART komande
	    }



  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  HAL_PWREx_ControlVoltageScaling(PWR_REGULATOR_VOLTAGE_SCALE1);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
  RCC_OscInitStruct.PLL.PLLM = RCC_PLLM_DIV1;
  RCC_OscInitStruct.PLL.PLLN = 9;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = RCC_PLLQ_DIV2;
  RCC_OscInitStruct.PLL.PLLR = RCC_PLLR_DIV2;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief SPI2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI2_Init(void)
{

  /* USER CODE BEGIN SPI2_Init 0 */

  /* USER CODE END SPI2_Init 0 */

  /* USER CODE BEGIN SPI2_Init 1 */

  /* USER CODE END SPI2_Init 1 */
  /* SPI2 parameter configuration*/
  hspi2.Instance = SPI2;
  hspi2.Init.Mode = SPI_MODE_MASTER;
  hspi2.Init.Direction = SPI_DIRECTION_2LINES;
  hspi2.Init.DataSize = SPI_DATASIZE_8BIT;
  hspi2.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi2.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi2.Init.NSS = SPI_NSS_SOFT;
  hspi2.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_8;
  hspi2.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi2.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi2.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi2.Init.CRCPolynomial = 7;
  hspi2.Init.CRCLength = SPI_CRC_LENGTH_DATASIZE;
  hspi2.Init.NSSPMode = SPI_NSS_PULSE_ENABLE;
  if (HAL_SPI_Init(&hspi2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI2_Init 2 */

  /* USER CODE END SPI2_Init 2 */

}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 3600;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = 78;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */

  /* USER CODE END TIM2_Init 2 */

}

/**
  * @brief UART4 Initialization Function
  * @param None
  * @retval None
  */
static void MX_UART4_Init(void)
{

  /* USER CODE BEGIN UART4_Init 0 */

  /* USER CODE END UART4_Init 0 */

  /* USER CODE BEGIN UART4_Init 1 */

  /* USER CODE END UART4_Init 1 */
  huart4.Instance = UART4;
  huart4.Init.BaudRate = 115200;
  huart4.Init.WordLength = UART_WORDLENGTH_8B;
  huart4.Init.StopBits = UART_STOPBITS_1;
  huart4.Init.Parity = UART_PARITY_NONE;
  huart4.Init.Mode = UART_MODE_TX_RX;
  huart4.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart4.Init.OverSampling = UART_OVERSAMPLING_16;
  huart4.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  huart4.Init.ClockPrescaler = UART_PRESCALER_DIV1;
  huart4.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
  if (HAL_UART_Init(&huart4) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_SetTxFifoThreshold(&huart4, UART_TXFIFO_THRESHOLD_1_8) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_SetRxFifoThreshold(&huart4, UART_RXFIFO_THRESHOLD_1_8) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_DisableFifoMode(&huart4) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN UART4_Init 2 */

  /* USER CODE END UART4_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMAMUX1_CLK_ENABLE();
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Channel1_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel1_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel1_IRQn);
  /* DMA1_Channel2_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel2_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel2_IRQn);
  /* DMA1_Channel3_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel3_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel3_IRQn);
  /* DMA1_Channel4_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Channel4_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Channel4_IRQn);

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  /* USER CODE BEGIN MX_GPIO_Init_1 */

  /* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOF_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOC, GPIO_PIN_9, GPIO_PIN_RESET);

  /*Configure GPIO pin : B1_Pin */
  GPIO_InitStruct.Pin = B1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(B1_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : LPUART1_TX_Pin LPUART1_RX_Pin */
  GPIO_InitStruct.Pin = LPUART1_TX_Pin|LPUART1_RX_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF12_LPUART1;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  /*Configure GPIO pin : LD2_Pin */
  GPIO_InitStruct.Pin = LD2_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(LD2_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : PC9 */
  GPIO_InitStruct.Pin = GPIO_PIN_9;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

  /* USER CODE BEGIN MX_GPIO_Init_2 */

  /* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
//Nakon što se triggera interrupt na rx, ova se funkcija automatski poziva

{
    if (huart->Instance == UART4)
    {
        if (rx_byte == '\n')   // kraj poruke, poruke koje šaljemo iz pythonu moraju zavrsavat na '\n'
        {
            rx_buffer[rx_index] = '\0';
            rx_index = 0;

            if (strcmp(rx_buffer, "#?#") == 0)
            {
                // SYNC zahtjev saljemo sa uartom u python skriptu
            	//preko uarta5 šaljemo znak !, koji sadrži samo jedan bajt i timeout je 100ms
                HAL_UART_Transmit(&huart4, (uint8_t*)"!", 1, 100);
            }
            else if (strcmp(rx_buffer, "#A#") == 0)
            {
            	//strcmp(a,b) - usporedjuje dva stringa i ako su jednaki vraca nulu
                // START STREAM
            	HAL_UART_Receive_IT(&huart4, &rx_byte, 1);
            	start_stream();
            }
            else if (strcmp(rx_buffer, "#S#") == 0)
            {
                // STOP STREAM
                stop_streaming();
            }
            else if(strcmp(rx_buffer, "#D#") == 0)
            {

            }
        }
        else
        {
            rx_buffer[rx_index++] = rx_byte;
            if (rx_index >= sizeof(rx_buffer))
                rx_index = 0;
        }

        HAL_UART_Receive_IT(&huart4, &rx_byte, 1);

    }
}

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef* htim){
	if(htim->Instance == TIM2){

		if (streaming)
			   {
			      transfer_complete = 0; //znaci da mozemo po sljedeci podatak sa SPI

			   }

	}


}


void stop_streaming(void)
{
	transfer_complete = 0;
    streaming = 0;
    HAL_UART_AbortTransmit(&huart4);
}


void start_stream(void){
	if (!streaming)
	  {
	    streaming = 1;
	    transfer_complete = 1;
	  }
}



int generate_ecg_sample(void)
	{
    if(mock_index == 19500){
    	mock_index = 0;
    }
    if(ecg_mock_data[mock_index] == 0){
    	int data = ecg_mock_data[mock_index];
    }
    mock_index += 1;
    return ecg_mock_data[mock_index];

	}




/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
